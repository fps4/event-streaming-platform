services:

  control-api:
    container_name: control-api
    build:
      context: .
      dockerfile: services/control-api/Dockerfile
    restart: unless-stopped
    ports: 
      - 7304:7304
    depends_on:
      - broker
      - mongodb
    networks:
      - event-streaming-platform
    environment:
      LOG_PRETTY: ${LOG_PRETTY:-false}
      CONTROL_API_PORT: ${CONTROL_API_PORT:-7304}
      AUTH_JWT_ISSUER: ${AUTH_JWT_ISSUER:-control-api}
      AUTH_JWT_AUDIENCE: ${AUTH_JWT_AUDIENCE:-control-api-ui}
      MONGO_URI: ${MONGO_URI:-mongodb://mongodb:27017}
      MONGO_DB: ${MONGO_DB:-control-api}
      CORS_ORIGINS: ${CORS_ORIGINS:-}
      KAFKA_BROKERS: ${KAFKA_BROKERS:-broker:9092}
      KAFKA_CLIENT_ID: ${KAFKA_CLIENT_ID:-control-api}
      KAFKA_USE_SSL: ${KAFKA_USE_SSL:-false}
      KAFKA_SASL_MECHANISM: ${KAFKA_SASL_MECHANISM:-}
      KAFKA_SASL_USERNAME: ${KAFKA_SASL_USERNAME:-}
      KAFKA_SASL_PASSWORD: ${KAFKA_SASL_PASSWORD:-}


  authorizer:
    container_name: authorizer
    build:
      context: .
      dockerfile: services/authorizer/Dockerfile
    restart: unless-stopped
    ports: 
      - 7305:7305
    depends_on:
      - mongodb
    networks:
      - event-streaming-platform
    environment:
      LOG_PRETTY: ${LOG_PRETTY:-false}
      AUTHORIZER_PORT: ${AUTHORIZER_PORT:-7305}
      AUTH_JWT_SECRET: ${AUTH_JWT_SECRET:?missing AUTH_JWT_SECRET}
      AUTH_JWT_ISSUER: ${AUTH_JWT_ISSUER:-authorizer-service}
      AUTH_JWT_AUDIENCE: ${AUTH_JWT_AUDIENCE:-api}
      MONGO_URI: ${MONGO_URI:-mongodb://mongodb:27017}
      AUTH_DB_NAME: ${AUTH_DB_NAME:-authdb}

  # Note: Multi-node implementation example https://hub.docker.com/r/apache/kafka
  broker:
    image: apache/kafka:latest
    hostname: broker
    container_name: broker
    networks:
      - event-streaming-platform
    ports:
      - 9092:9092
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://broker:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@broker:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_PARTITIONS: 3

  connector-http-source:
    container_name: connector-http-source
    build:
      context: .
      dockerfile: services/connector-http-source/Dockerfile
    restart: unless-stopped
    depends_on:
      - broker
    networks:
      - event-streaming-platform
    environment:
      PORT: 8085
      NODE_ENV: ${APP_ENV:-development}
      KAFKA_BROKERS: ${KAFKA_BROKERS:-broker:9092}
      KAFKA_CLIENT_ID: ${KAFKA_CLIENT_ID:-connector-http-source}
    ports:
      - "8085:8085"
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:8085/health').then(res => process.exit(res.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 5

  connector-http-sink:
    container_name: connector-http-sink
    build:
      context: .
      dockerfile: services/connector-http-sink/Dockerfile
    restart: unless-stopped
    depends_on:
      - broker
    networks:
      - event-streaming-platform
    environment:
      PORT: 8086
      NODE_ENV: ${APP_ENV:-development}
      KAFKA_BROKERS: ${KAFKA_BROKERS:-broker:9092}
      KAFKA_CLIENT_ID: ${KAFKA_CLIENT_ID:-connector-http-sink}
      KAFKA_GROUP_ID: ${KAFKA_GROUP_ID:-connector-http-sink}
      HTTP_SINK_TOPICS: ${HTTP_SINK_TOPICS:-}
    ports:
      - "8086:8086"
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:8086/health').then(res => process.exit(res.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 5

  worker-jsonata:
    container_name: worker-jsonata
    build:
      context: .
      dockerfile: services/worker-jsonata/Dockerfile
    restart: unless-stopped
    depends_on:
      - broker
      - control-api
      - mongodb
    networks:
      - event-streaming-platform
    environment:
      NODE_ENV: ${APP_ENV:-development}
      LOG_LEVEL: info
      KAFKA_BROKERS: ${KAFKA_BROKERS:-broker:9092}
      KAFKA_CLIENT_ID: ${KAFKA_CLIENT_ID:-worker-jsonata}
      KAFKA_GROUP_ID: ${KAFKA_GROUP_ID:-worker-jsonata}
      WORKSPACE_ID: ${WORKSPACE_ID:-}
      DLQ_TOPIC: ${DLQ_TOPIC:-}
      MONGO_URI: ${MONGO_URI:-mongodb://mongodb:27017}
      MONGO_DB: ${MONGO_DB:-control-api}

  kafka-connect:
    build:
      context: .
      dockerfile: services/kafka-connect/Dockerfile
      args:
        CP_VERSION: 7.7.7
        CONNECT_HTTP_SOURCE_VERSION: 1.0.1
        CONNECT_HTTP_VERSION: 1.7.11
        CONNECT_TRANSFORMS_VERSION: 1.4.3
    depends_on:
      - broker
    networks:
      - event-streaming-platform
    environment:
      CONNECT_BOOTSTRAP_SERVERS: broker:9092
      CONNECT_REST_PORT: 8083
      CONNECT_REST_ADVERTISED_HOST_NAME: kafka-connect
      CONNECT_GROUP_ID: kafka-connect
      CONNECT_CONFIG_STORAGE_TOPIC: _connect-configs
      CONNECT_OFFSET_STORAGE_TOPIC: _connect-offsets
      CONNECT_STATUS_STORAGE_TOPIC: _connect-status
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_KEY_CONVERTER: org.apache.kafka.connect.storage.StringConverter
      CONNECT_VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE: "false"
      CONNECT_INTERNAL_KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_INTERNAL_VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_LOG4J_ROOT_LOGLEVEL: INFO
      CONNECT_PLUGIN_PATH: /usr/share/java,/usr/share/confluent-hub-components
    ports:
      - "8083:8083"

  schema-registry:
    image: confluentinc/cp-schema-registry:latest
    ports:
      - "8081:8081"
    depends_on:
      - broker
    networks:
      - event-streaming-platform
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: PLAINTEXT://broker:9092
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081

  ksqldb:
    image: confluentinc/ksqldb-server:latest
    container_name: ksqldb
    ports:
      - "8088:8088"
    depends_on:
      - broker
      - schema-registry
    networks:
      - event-streaming-platform
    environment:
      KSQL_LISTENERS: http://0.0.0.0:8088
      KSQL_BOOTSTRAP_SERVERS: PLAINTEXT://broker:9092
      KSQL_KSQL_SCHEMA_REGISTRY_URL: http://schema-registry:8081
      KSQL_KSQL_SERVICE_ID: ksqldb
    
  mongodb:
    container_name: mongodb
    # MongoDB 5.0+ requires AVX; using `mongo:latest` pulls a newer major
    # DS2 server is an older CPU that does not support AVX2 instructions
    # Ref: https://github.com/flakybitnet/mongodb-oci
    image: ghcr.io/flakybitnet/mongodb-server:8.0.13-fb1
    restart: unless-stopped
    ports:
      - 27019:27017
    networks:
      - event-streaming-platform
    volumes:
      - mongo_data:/data/db

  # clickhouse:
  #   build:
  #     context: .
  #     dockerfile: ./services/clickhouse/Dockerfile
  #     args:
  #       CLICKHOUSE_USER: ${CLICKHOUSE_USER}
  #       CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
  #       CLICKHOUSE_DB: ${CLICKHOUSE_DB}
  #   restart: unless-stopped
  #   ports:
  #     - "8123:8123"   # HTTP interface
  #     - "9000:9000"   # Native TCP interface
  #   volumes:
  #     - clickhouse_data:/var/lib/clickhouse
  #   networks:
  #     - event-streaming-platform

  # clickhouse-init:
  #   build:
  #     context: .
  #     dockerfile: ./services/clickhouse/Dockerfile-init
  #     args:
  #       CLICKHOUSE_USER: ${CLICKHOUSE_USER}
  #       CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
  #       CLICKHOUSE_DB: ${CLICKHOUSE_DB}
  #   restart: 'no'
  #   depends_on:
  #     - clickhouse
  #     - broker
  #   networks:
  #     - event-streaming-platform
      

networks:
  event-streaming-platform:
    driver: bridge

volumes:
  mongo_data:
    driver: local
  clickhouse_data:
    driver: local